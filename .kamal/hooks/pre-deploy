#!/usr/bin/env bash
set -euo pipefail

if [[ "${KAMAL_COMMAND:-}" == "rollback" ]] || [[ "${KAMAL_DESTINATION:-production}" != "production" ]]; then
  exit 0
fi

RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[0;33m"
NC="\033[0m"

EXPECTED_BRANCH="main"
REMOTE="origin"

git fetch "$REMOTE"

if [[ -n "$(git status --porcelain)" ]]; then
  echo -e "${RED}ERROR: Working tree is dirty${NC}"
  git status --short
  exit 1
fi

current_branch="$(git branch --show-current)"
if [[ "$current_branch" != "$EXPECTED_BRANCH" ]]; then
  echo -e "${RED}ERROR: Must deploy from branch $EXPECTED_BRANCH (currently on $current_branch)${NC}"
  exit 1
fi

if [[ -n "$(git rev-list "$REMOTE/$EXPECTED_BRANCH"..HEAD)" ]]; then
  echo -e "${RED}ERROR: HEAD contains commits not pushed to $REMOTE/$EXPECTED_BRANCH${NC}"
  echo "Unpushed commits:"
  git log --oneline "$REMOTE/$EXPECTED_BRANCH"..HEAD
  exit 1
fi

echo -e "${GREEN}Preflight checks passed â€” safe to deploy${NC}"
